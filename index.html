<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gym-Log Pro (Definitive Edition)</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèãÔ∏è</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        :root {
            --bg-color: #121212;
            --card-color: #1E1E1E; --text-color: #E0E0E0; --text-secondary-color: #A0A0A0;
            --primary-color: #03dac6; --primary-gradient: linear-gradient(45deg, #03dac6, #018786);
            --secondary-color: #bb86fc; --secondary-gradient: linear-gradient(45deg, #bb86fc, #6200ee);
            --border-color: #333;
            --success-color: #4CAF50; --success-gradient: linear-gradient(45deg, #4CAF50, #2e7d32);
            --pr-color: #FFD700; --danger-color: #f44336;
            --font-main: 'Sarabun', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.15);
            --shadow-md: 0 5px 15px rgba(0,0,0,0.2);
        }
        body.light-mode {
            --bg-color: #F0F2F5;
            --card-color: #FFFFFF; --text-color: #1c1e21; --text-secondary-color: #65676B;
            --border-color: #E4E6EB;
        }
        body{font-family: var(--font-main); background-color:var(--bg-color);color:var(--text-color);margin:0;padding:15px 15px 100px 15px; transition: background-color 0.3s, color 0.3s;}
        .container{max-width:600px;margin:auto;}
        h1,h2,h3{color:var(--text-color);border-bottom:1px solid var(--border-color);padding-bottom:10px; font-weight: 700;}
        h1 { color: var(--primary-color); }
        h2 { color: var(--secondary-color); }
        .page-title { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        #workout-day-title { flex-grow: 1; }
        .override-btn { font-size: 0.8em; padding: 6px 12px; border-radius: 20px; background-color: var(--card-color); border: 1px solid var(--border-color); color: var(--text-secondary-color); cursor: pointer; white-space: nowrap;}
        .override-btn:hover { background-color: var(--border-color); color: var(--text-color); }
        #total-duration-display { font-size: 0.7em; font-weight: 500; color: var(--text-secondary-color); background-color: var(--card-color); padding: 4px 8px; border-radius: 10px; border: 1px solid var(--border-color); }
        h2 .back-button { font-size: 0.8em; color: var(--text-color); background-color: var(--card-color); border: 1px solid var(--border-color); padding: 5px 12px; border-radius: 20px; text-decoration: none; margin-right: 15px; cursor: pointer; display: inline-flex; align-items: center; gap: 5px;}
        h2 .editable-title { cursor: pointer; text-decoration: underline; text-decoration-style: dotted;}
        h3{font-size:1.1em; border-bottom-width:1px; margin-top:25px; margin-bottom:15px;}
        .card{background-color:var(--card-color);border-radius:12px;padding: 20px;margin-bottom:15px;border:1px solid var(--border-color);transition: all .3s; box-shadow: var(--shadow-sm);}
        .ex-header{display:flex;justify-content:space-between;align-items:center; margin-bottom: 10px;}
        .ex-title-container{display:flex;align-items:center;gap:10px; flex-grow: 1;}
        .exercise-title{font-size:1.3em;font-weight:700;color:var(--secondary-color);}
        .pr-star {color:var(--pr-color);font-size:1.2em;display:none; transition: transform 0.3s;}
        .exercise-notes{font-size:1em;color:var(--text-secondary-color); margin-bottom: 15px;}
        .log-input, .add-exercise-form{display:flex;gap:10px;margin-bottom:10px;}
        .log-input input,.log-input select,#exercise-select,.text-input,#body-stat-select, #history-search, .add-exercise-form input, .add-exercise-form select{width:100%;padding:12px;border-radius:8px;border:1px solid var(--border-color);background-color:var(--bg-color);color:var(--text-color);font-size:1em;box-sizing:border-box;}
        .action-btn{display:flex; align-items: center; justify-content: center; gap: 8px; width:100%;padding:12px;margin:10px 0;border:none;border-radius:8px;font-weight:700;cursor:pointer; transition: all 0.2s; font-size: 1.05em; text-shadow: 1px 1px 2px rgba(0,0,0,0.2);}
        .action-btn.primary { background: var(--primary-gradient); color: #000; }
        .action-btn.primary:hover { opacity: 0.9; box-shadow: var(--shadow-md); transform: translateY(-2px); }
        .action-btn.secondary { background: var(--secondary-color); color: #fff; }
        .action-btn.secondary:hover { opacity: 0.9; box-shadow: var(--shadow-md); transform: translateY(-2px); }
        .action-btn.success { background: var(--success-gradient); color: #fff; }
        .action-btn.success:hover { opacity: 0.9; box-shadow: var(--shadow-md); transform: translateY(-2px); }
        .action-btn.neutral { background-color: #555; color: #fff; }
        .action-btn.neutral:hover { background-color: #666; }
        .action-btn.danger { background-color: var(--danger-color); color: #fff; }
        .action-btn.danger:hover { opacity: 0.9; }
        .util-btn { padding: 0; height: 44px; width: 44px; flex-shrink: 0; font-size: 1.2em; font-weight: bold; background-color: transparent; border: 1px solid var(--border-color); color: var(--text-secondary-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .util-btn:hover { background-color: var(--border-color); color: var(--text-color); }
        textarea,.backup-textarea{width:calc(100% - 24px);background-color:#2b2b2b;color:var(--text-color);border:1px solid var(--border-color);border-radius:8px;padding:10px;margin-top:10px;min-height:40px;font-family:inherit;font-size:.9em;}
        body.light-mode .log-input input, body.light-mode .log-input select, body.light-mode .text-input, body.light-mode textarea, body.light-mode .util-btn, body.light-mode #history-search, body.light-mode .add-exercise-form input, body.light-mode .add-exercise-form select { background-color: #f0f2f5; }
        .tab-buttons{display:flex;margin-bottom:20px;border-bottom:1px solid var(--border-color); background-color: var(--card-color); border-radius: 12px; padding: 5px; box-shadow: var(--shadow-sm);}
        .tab-button{flex-grow:1;padding:10px 5px; text-align: center; background-color:transparent;border:none;color:var(--text-secondary-color);font-size:1em;font-weight:500;cursor:pointer;border-radius: 8px; transition:all .3s;}
        .tab-button.active{color:var(--primary-color);background-color: rgba(3, 218, 198, 0.1);}
        .page{display:none; animation: fadeIn 0.5s;}
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .page.active{display:block;}
        .list-item{display:flex;justify-content:space-between;align-items:center;padding:12px;background-color:var(--bg-color);border-radius:8px;margin-bottom:8px;}
        .btn-group button, .btn-group input {margin-left:5px;background:none;border:none;color:var(--text-secondary-color);border-radius:4px;padding:5px 8px;cursor:pointer; display: flex; align-items: center;}
        .btn-group button:hover { background-color: var(--border-color); color: var(--text-color); }
        .btn-group button:disabled { opacity: 0.3; cursor: not-allowed; }
        .btn-delete{background: none; border: none; cursor: pointer; padding: 5px; color: var(--text-secondary-color);}
        .btn-delete:hover{color:var(--danger-color)!important; background-color: rgba(244, 67, 54, 0.1);}
        #rest-timer{position:fixed;bottom:0;left:0;width:100%;background-color:var(--card-color);padding:10px;box-sizing:border-box;box-shadow:0 -2px 10px rgba(0,0,0,.5);display:none;justify-content:space-around;align-items:center;}
        #timer-display{font-size:2em;color:var(--primary-color);font-weight:700;}
        #timer-display button{background:none;border:1px solid var(--primary-color);color:var(--primary-color);padding:8px 12px;border-radius:8px;}
        .suggestion-card{border-left:5px solid var(--pr-color); padding:15px; background-color:rgba(255,215,0,.1); margin-bottom: 20px; border-radius: 8px;}
        #history-container .card { position: relative; padding: 20px; }
        #history-container h3 { border-bottom: 1px solid var(--border-color); padding-bottom: 8px; margin-top: 20px; }
        #body-stats-history-list { padding-left: 0; }
        #body-stats-history-list li { list-style-type: none; background-color:var(--card-color); padding:15px; margin-bottom:10px; border-radius:8px; white-space:pre-wrap; font-family:'Courier New',Courier,monospace; line-height:1.6;}
        .stat-input-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .chart-container{margin-top:20px;margin-bottom:30px;}
        .feather { width: 1.1em; height: 1.1em; vertical-align: -0.15em; stroke-width: 2.5; }
        .history-exercise-title { cursor: pointer; font-weight: 700; color: var(--secondary-color); padding: 5px; border-radius: 5px; transition: background-color 0.2s; flex-grow: 1; }
        .history-exercise-title:hover { background-color: var(--border-color); }
        .pr-highlight { color: var(--pr-color) !important; font-weight: bold; }
        .history-details-grid { display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 10px; font-size: 0.9em; margin-left: 15px;}
        .history-set-item { background-color: var(--bg-color); padding: 8px; border-radius: 6px; margin-top: 5px; animation: slideIn 0.4s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        .set-item-details { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .estimated-1rm { font-size: 0.8em; font-weight: 500; color: var(--primary-color); background-color: rgba(3, 218, 198, 0.1); padding: 2px 6px; border-radius: 4px; }
        .pr-item { cursor: pointer; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 12px; overflow: hidden;}
        .pr-item-header { display: flex; justify-content: space-between; align-items: center; padding: 18px 15px; border-left: 5px solid var(--pr-color); }
        .pr-exercise-name { font-size: 1.2em; font-weight: 700; }
        .pr-weight { font-size: 1.4em; font-weight: 700; color: var(--pr-color); }
        .rep-pr-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .rep-pr-table th, .rep-pr-table td { padding: 8px 12px; text-align: center; border-bottom: 1px solid var(--border-color); }
        .rep-pr-table th { font-weight: 500; color: var(--text-secondary-color); font-size: 0.9em; }
        .rep-pr-details { padding: 0 15px 15px 15px; max-height: 0; opacity: 0; transition: all 0.4s ease-in-out; }
        .pr-item.open .rep-pr-details { max-height: 500px; opacity: 1; }
        #last-time-summary { border-left: 5px solid var(--secondary-color); background-color: rgba(187, 134, 252, 0.05); }
        #last-time-content p { margin: 0 0 8px 0; color: var(--text-secondary-color); }
        #last-time-content strong { color: var(--text-color); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); animation: fadeIn 0.3s; }
        .modal-content { background-color: var(--card-color); margin: 5% auto; padding: 20px; border: 1px solid var(--border-color); border-radius: 12px; width: 90%; max-width: 500px; text-align: center; }
        .close-button { color: var(--text-secondary-color); float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .barbell-vis { display: flex; align-items: center; justify-content: center; margin: 20px 0; min-height: 80px; }
        .plate { border: 2px solid var(--border-color); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: var(--text-color); margin: 0 2px; height: 60px; min-width: 40px; padding: 0 5px; background-color: var(--bg-color); }
        .barbell-sleeve { background-color: #BDBDBD; height: 40px; width: 20px; border-radius: 2px; }
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: left; margin: 20px 0; }
        .summary-item h4 { margin: 0; color: var(--secondary-color); font-size: 1em;}
        .summary-item p { margin: 5px 0 0 0; font-size: 1.5em; font-weight: 700; }
        #summary-prs-list li { list-style-type: none; background-color: var(--bg-color); padding: 10px; border-radius: 8px; margin-bottom: 8px; text-align: left;}
        .feedback-message { font-size: 0.9em; color: var(--primary-color); background-color: rgba(3, 218, 198, 0.1); border-left: 3px solid var(--primary-color); padding: 10px; margin-top: 10px; border-radius: 4px; animation: fadeIn 0.5s;}
        #override-list button { width: 100%; text-align: left; }
        .exercise-card.freestyle { border-left: 5px solid var(--success-color); }
        .rest-day-card { background: var(--secondary-gradient); color: #fff; text-align: center; padding: 30px 20px; border-radius: 12px; border: none; box-shadow: var(--shadow-md); animation: fadeIn 0.8s ease-out; }
        .rest-day-card h2 { color: #fff; border: none; margin-top: 0; font-size: 1.8em; display: flex; align-items: center; justify-content: center; gap: 12px; }
        .rest-day-card p { opacity: 0.9; margin-bottom: 25px; }
        .next-workout-preview { background-color: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; text-align: left; }
        .next-workout-preview h4 { margin: 0 0 10px 0; opacity: 0.8; font-size: 1em; font-weight: 500; }
        .next-workout-preview .exercise-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .next-workout-preview .exercise-item:last-child { border-bottom: none; }
        .next-workout-preview .exercise-name { font-weight: 700; flex-grow: 1; }
        .next-workout-preview .last-performance { font-size: 0.9em; opacity: 0.8; }
    </style>
</head>
<body>

<div class="container">
    <div class="tab-buttons">
        <button class="tab-button active" onclick="showPage('workout')">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
        <button class="tab-button" onclick="showPage('plans')">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ù‡∏∂‡∏Å</button>
        <button class="tab-button" onclick="showPage('prs')">PRs</button>
        <button class="tab-button" onclick="showPage('body')">‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢</button>
        <button class="tab-button" onclick="showPage('history')">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
        <button class="tab-button" onclick="showPage('analysis')">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</button>
        <button class="tab-button" onclick="showPage('settings')">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
    </div>

    <div id="workout" class="page active">
        <div class="page-title">
            <h1 id="workout-day-title"></h1>
            <button id="override-btn" class="override-btn" onclick="showOverrideModal()">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</button>
            <span id="total-duration-display"></span>
        </div>
        <div id="last-time-summary" class="card" style="display: none;">
            <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß</h3>
            <div id="last-time-content"></div>
        </div>
        <div id="smart-assistant-box"></div>
        <div id="quick-log-form" class="card" style="display: none;">
            <h3>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πà‡∏ß‡∏ô (Freestyle)</h3>
            <div class="log-input" style="flex-direction: column; gap:10px;">
                <input type="text" id="quick-log-exercise" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢" class="text-input">
                <select id="quick-log-muscle-group"></select>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="quick-log-weight" placeholder="‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (kg)" class="text-input">
                    <input type="number" id="quick-log-reps" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á" class="text-input">
                </div>
            </div>
            <button class="action-btn success" onclick="saveQuickLog()"><i data-feather="plus-circle"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
        <div id="exercise-list"></div>
        <button id="toggle-quick-log-btn" class="action-btn neutral" onclick="toggleQuickLogForm()"><i data-feather="zap"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πà‡∏ß‡∏ô (Freestyle)</button>
        <button id="finish-workout-btn" class="action-btn success" onclick="showWorkoutSummary()"><i data-feather="check-circle"></i>‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å</button>
    </div>
    <div id="plans" class="page"><div id="plan-editor-view"></div></div>
    <div id="prs" class="page">
        <h2>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (Personal Records)</h2>
        <p style="font-size:0.9em; opacity:0.8; margin-top:-10px; margin-bottom:20px;">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ó‡πà‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (Rep PRs)</p>
        <div id="pr-list-container"></div>
    </div>
    <div id="body" class="page">
        <h2>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢</h2>
        <div class="card">
            <h3>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
            <div class="stat-input-group">
                <input type="number" id="stat-weight" placeholder="‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏±‡∏ß (kg)"><input type="number" id="stat-bf" placeholder="% ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô">
                <input type="number" id="stat-chest" placeholder="‡∏£‡∏≠‡∏ö‡∏≠‡∏Å (cm)"><input type="number" id="stat-waist" placeholder="‡∏£‡∏≠‡∏ö‡πÄ‡∏≠‡∏ß (cm)">
                <input type="number" id="stat-arm" placeholder="‡∏£‡∏≠‡∏ö‡πÅ‡∏Ç‡∏ô (cm)">
            </div>
            <button class="action-btn success" onclick="saveBodyStats()"><i data-feather="save"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
        <div class="card">
            <h3>‡∏Å‡∏£‡∏≤‡∏ü‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</h3>
            <select id="body-stat-select" onchange="renderBodyStatChart(this.value)"></select>
            <div class="chart-container"><canvas id="bodyStatChart"></canvas></div>
        </div>
        <div class="card">
             <h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h3><ul id="body-stats-history-list"></ul>
        </div>
    </div>
    <div id="history" class="page">
        <h2>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å</h2>
        <input type="text" id="history-search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡πà‡∏≤..." onkeyup="filterHistory()">
        <div id="history-container" style="margin-top: 15px;"></div>
    </div>
    <div id="analysis" class="page">
        <h2>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤</h2>
        <div class="card">
            <h3>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠ (30 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</h3>
            <div class="chart-container">
                <canvas id="muscleBalanceChart"></canvas>
            </div>
        </div>
        <div class="card">
            <h3>‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ó‡πà‡∏≤</h3>
            <select id="exercise-select"></select>
            <div id="exercise-analysis-content"></div>
        </div>
    </div>
    <div id="settings" class="page">
        <h2>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
        <div class="card">
            <h3>‡∏ò‡∏µ‡∏°</h3>
            <button class="action-btn secondary" onclick="toggleTheme()"><i data-feather="moon"></i>‡∏™‡∏•‡∏±‡∏ö‡∏ò‡∏µ‡∏°</button>
        </div>
        <div class="card">
            <h3>‡πÇ‡∏£‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå (Home Gym)</h3>
            <p style="opacity:0.8; font-size:0.9em;">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡πà‡∏ô‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ‚öñÔ∏è ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì</p>
            <div class="log-input" style="flex-direction: column; gap: 15px;">
                <input type="number" id="equipment-barbell-weight" placeholder="‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÅ‡∏Å‡∏ô‡πÄ‡∏õ‡∏•‡πà‡∏≤ (kg)">
                <input type="text" id="equipment-plates" placeholder="‡πÅ‡∏ú‡πà‡∏ô‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏°‡∏µ (‡πÄ‡∏ä‡πà‡∏ô 10, 5, 2.5, 1.25)">
            </div>
            <button class="action-btn success" onclick="saveEquipmentSettings()"><i data-feather="save"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</button>
        </div>
        <div class="card">
            <h3>‡∏™‡∏≥‡∏£‡∏≠‡∏á/‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
            <p style="opacity:0.8; font-size:0.9em;">‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>
            <button class="action-btn secondary" onclick="backupDataToFile()"><i data-feather="download"></i>‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå</button>
            <button class="action-btn success" onclick="document.getElementById('restore-file-input').click();"><i data-feather="upload"></i>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå</button>
            <input type="file" id="restore-file-input" accept=".json" style="display: none;">
        </div>
    </div>
</div>

<div id="rest-timer">
    <button onclick="adjustTimer(-15)">-15s</button>
    <div id="timer-display">1:30</div>
    <button onclick="adjustTimer(15)">+15s</button>
    <button onclick="stopTimer()">‡∏´‡∏¢‡∏∏‡∏î</button>
</div>

<div id="plate-calculator-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal('plate-calculator-modal')">&times;</span>
        <h2>Plate Calculator</h2>
        <h3 id="calculator-target-weight" style="border:none;"></h3>
        <div class="barbell-vis" id="barbell-visualization"></div>
        <p id="plates-per-side-text"></p>
    </div>
</div>

<div id="summary-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal('summary-modal')">&times;</span>
        <h2 style="color:var(--success-color);">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å!</h2>
        <div class="summary-grid">
            <div class="summary-item">
                <h4>Total Volume</h4>
                <p id="summary-volume">0 kg</p>
            </div>
            <div class="summary-item">
                <h4>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</h4>
                <p id="summary-duration">00:00:00</p>
            </div>
             <div class="summary-item">
                <h4>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ã‡πá‡∏ï</h4>
                <p id="summary-sets">0</p>
            </div>
        </div>
        <div id="summary-prs-container" style="display:none;">
            <h3 style="color:var(--pr-color); border-color: var(--pr-color);">‚≠ê PRs ‡πÉ‡∏´‡∏°‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ!</h3>
            <ul id="summary-prs-list" style="padding-left: 0;"></ul>
        </div>
        <button class="action-btn secondary" onclick="closeModal('summary-modal')">‡∏õ‡∏¥‡∏î</button>
    </div>
</div>

<div id="override-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal('override-modal')">&times;</span>
        <h2>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏•‡πà‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2>
        <div id="override-list"></div>
    </div>
</div>

<script>
    const DEFAULT_REST_TIME = 90;
    let workoutStartTime = null, workoutTimerInterval = null;
    let currentWorkoutLog = {}, personalRecords = {}, bodyStats = [];
    let currentSessionPRs = [];
    let timerInterval, timeRemaining, audioContext, chartVolume, chartStrength, bodyStatChart, muscleBalanceChart;
    let workoutPlans = [], activePlanIndex = 0;
    let userEquipment = { barbellWeight: 20, availablePlates: [20, 15, 10, 5, 2.5, 1.25] };
    const defaultPlan = [{ name: "‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô 4 ‡∏ß‡∏±‡∏ô/‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå", active: true, days: [ { name: "Upper A (‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå)", exercises: [{name: "Incline Dumbbell Press", muscleGroup: "Chest"}, {name: "One-arm Dumbbell Row", muscleGroup: "Back"}, {name: "Dumbbell Lateral Raise", muscleGroup: "Shoulders"}, {name: "Dumbbell Curl", muscleGroup: "Arms"}, {name: "Overhead Triceps Extension", muscleGroup: "Arms"}] }, { name: "Lower A (‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£)", exercises: [{name: "Goblet Squat", muscleGroup: "Legs"}, {name: "Dumbbell Romanian Deadlift (RDL)", muscleGroup: "Legs"}, {name: "Hip Thrust", muscleGroup: "Legs"}, {name: "Calf Raise", muscleGroup: "Legs"}] }, { name: "‡∏û‡∏±‡∏Å (‡∏û‡∏∏‡∏ò)", exercises: [] }, { name: "Upper B (‡∏û‡∏§‡∏´‡∏±‡∏™‡∏Ø)", exercises: [{name: "Flat Dumbbell Press", muscleGroup: "Chest"}, {name: "Pull-up / Band Pull-down", muscleGroup: "Back"}, {name: "Dumbbell Shoulder Press", muscleGroup: "Shoulders"}, {name: "Dumbbell Hammer Curl", muscleGroup: "Arms"}, {name: "Bench Dips", muscleGroup: "Arms"}] }, { name: "Lower B (‡∏®‡∏∏‡∏Å‡∏£‡πå)", exercises: [{name: "Bulgarian Split Squat", muscleGroup: "Legs"}, {name: "Sumo Goblet Squat", muscleGroup: "Legs"}, {name: "Dumbbell Step-up", muscleGroup: "Legs"}, {name: "Standing Calf Raise", muscleGroup: "Legs"}] }, { name: "‡∏û‡∏±‡∏Å (‡πÄ‡∏™‡∏≤‡∏£‡πå)", exercises: [] }, { name: "‡∏û‡∏±‡∏Å (‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå)", exercises: [] } ] }];
    const muscleGroups = { 'Chest': '‡∏≠‡∏Å', 'Back': '‡∏´‡∏•‡∏±‡∏á', 'Legs': '‡∏Ç‡∏≤', 'Shoulders': '‡πÑ‡∏´‡∏•‡πà', 'Arms': '‡πÅ‡∏Ç‡∏ô', 'Core': '‡πÅ‡∏Å‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏•‡∏≥‡∏ï‡∏±‡∏ß', 'Other': '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' };

    function vibrate(duration = 50) { if ('vibrate' in navigator) { try { navigator.vibrate(duration); } catch (e) { console.warn("Could not vibrate:", e); } } }
    
    function getMuscleGroup(exerciseName) {
        const lowerExName = exerciseName.toLowerCase();
        // Exact matches first
        if (lowerExName === 'dips') return 'Chest';
        if (lowerExName === 'deadlift') return 'Back';
        
        const keywordMap = { 'press': 'Chest', 'push-up': 'Chest', 'fly': 'Chest', 'row': 'Back', 'pull-up': 'Back', 'pulldown': 'Back', 'squat': 'Legs', 'lunge': 'Legs', 'step-up': 'Legs', 'thrust': 'Legs', 'calf raise': 'Legs', 'shoulder press': 'Shoulders', 'lateral raise': 'Shoulders', 'front raise': 'Shoulders', 'curl': 'Arms', 'triceps extension': 'Arms', 'hammer curl': 'Arms', 'crunch': 'Core', 'plank': 'Core', 'leg raise': 'Core' };
        for (const keyword in keywordMap) { if (lowerExName.includes(keyword)) return keywordMap[keyword]; }
        return 'Other';
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        try {
            try { audioContext = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) { console.error("Web Audio API not supported"); }
            runDataMigrations();
            loadAllData();
            renderAllPages();
            feather.replace();
        } catch (error) {
            console.error("A critical error occurred during initialization:", error);
            const body = document.querySelector('body');
            body.innerHTML = `<div style="text-align: center; padding: 50px; color: #ff6b6b;"><h1>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á</h1><p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏Ñ‡∏ä‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏≤‡∏Å‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p><p><i>Error: ${error.message}</i></p></div>`;
        }
    });

    function renderAllPages() {
        renderPlanListView();
        setupTodayWorkout();
        applyTheme();
        populateMuscleGroupSelects();
        document.getElementById('exercise-select').addEventListener('change', (e) => generateExerciseCharts(e.target.value));
        document.getElementById('restore-file-input').addEventListener('change', handleRestoreFile);
        renderPRsPage();
        renderAnalysisPage();
        renderBodyStatsPage();
        loadHistory();
        updateEquipmentInputs();
    }
    
    function applyTheme() { const theme = localStorage.getItem("gymLogTheme") || "dark"; document.body.className = theme === "dark" ? "" : "light-mode"; }
    function toggleTheme() { const newTheme = document.body.classList.contains("light-mode") ? "dark" : "light"; document.body.className = newTheme === "dark" ? "" : "light-mode"; localStorage.setItem("gymLogTheme", newTheme); }
    
    function loadAllData() {
        personalRecords = JSON.parse(localStorage.getItem('gymLogPRs_v4') || '{}');
        bodyStats = JSON.parse(localStorage.getItem('gymBodyStats') || '[]');
        
        let storedPlans = [];
        try {
            const storedPlansJSON = localStorage.getItem('gymWorkoutPlans_v3');
            if (storedPlansJSON) {
                const parsed = JSON.parse(storedPlansJSON);
                if (Array.isArray(parsed) && parsed.length > 0) {
                    storedPlans = parsed;
                }
            }
        } catch (e) {
            console.error("Could not parse workout plans from localStorage", e);
            storedPlans = []; 
        }
        workoutPlans = storedPlans.length > 0 ? storedPlans : defaultPlan;

        const storedEquipment = localStorage.getItem('gymUserEquipment'); 
        if (storedEquipment) userEquipment = JSON.parse(storedEquipment);

        activePlanIndex = workoutPlans.findIndex(p => p.active); 
        if (activePlanIndex === -1) { 
            activePlanIndex = 0; 
            if(workoutPlans.length > 0) workoutPlans[0].active = true; 
        }
    }

    function saveData() { localStorage.setItem('gymWorkoutPlans_v3', JSON.stringify(workoutPlans)); }
    function backupDataToFile() { const backupObj = { version: 4, history: JSON.parse(localStorage.getItem('gymLogHistory_v2') || '[]'), prs: JSON.parse(localStorage.getItem('gymLogPRs_v4') || '{}'), plans: JSON.parse(localStorage.getItem('gymWorkoutPlans_v3') || JSON.stringify(defaultPlan)), body: JSON.parse(localStorage.getItem('gymBodyStats') || '[]'), equipment: JSON.parse(localStorage.getItem('gymUserEquipment') || JSON.stringify(userEquipment)) }; const jsonString = JSON.stringify(backupObj, null, 2); const blob = new Blob([jsonString], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); const today = new Date().toISOString().slice(0, 10); a.href = url; a.download = `gym-log-backup-${today}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); alert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...'); }
    function handleRestoreFile(event) { const file = event.target.files[0]; if (!file) { return; } const reader = new FileReader(); reader.onload = function(e) { const backupString = e.target.result; restoreData(backupString); }; reader.onerror = function() { alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå'); }; reader.readAsText(file); event.target.value = ''; }
    function restoreData(backupString) { if (!backupString) { alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤'); return; } if (!confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö!")) return; try { const backupObj = JSON.parse(backupString); let restoredSomething = false; if (backupObj.history) { localStorage.setItem('gymLogHistory_v2', JSON.stringify(backupObj.history)); restoredSomething = true; } if (backupObj.prs) { localStorage.setItem('gymLogPRs_v4', JSON.stringify(backupObj.prs)); restoredSomething = true; } if (backupObj.plans) { localStorage.setItem('gymWorkoutPlans_v3', JSON.stringify(backupObj.plans)); restoredSomething = true; } if (backupObj.body) { localStorage.setItem('gymBodyStats', JSON.stringify(backupObj.body)); restoredSomething = true; } if (backupObj.equipment) { localStorage.setItem('gymUserEquipment', JSON.stringify(backupObj.equipment)); restoredSomething = true; } if (restoredSomething) { runDataMigrations(); location.reload(); alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÅ‡∏≠‡∏õ‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà'); } else { alert('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); } } catch (e) { alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•! ‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏≤‡∏à‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); console.error("Restore error: ", e); } }
    function saveEquipmentSettings() { const barbellWeightInput = document.getElementById('equipment-barbell-weight'); const platesInput = document.getElementById('equipment-plates'); const barbellWeight = parseFloat(barbellWeightInput.value); const plates = platesInput.value.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n) && n > 0).sort((a, b) => b - a); if (isNaN(barbellWeight) || barbellWeight < 0) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); return; } if (plates.length === 0) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏ú‡πà‡∏ô‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ç‡∏ô‡∏≤‡∏î"); return; } userEquipment = { barbellWeight, availablePlates: plates }; localStorage.setItem('gymUserEquipment', JSON.stringify(userEquipment)); alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); feather.replace(); }
    function updateEquipmentInputs() { const barbellWeightInput = document.getElementById('equipment-barbell-weight'); const platesInput = document.getElementById('equipment-plates'); if (barbellWeightInput && platesInput) { barbellWeightInput.value = userEquipment.barbellWeight; platesInput.value = userEquipment.availablePlates.join(', '); } }
    
    function runDataMigrations() {
        console.log("Running data migrations...");
        let migrationPerformed = false;
        
        // --- Migration from old text-based history to JSON format ---
        const oldHistoryRaw = localStorage.getItem('gymLogHistory');
        if (oldHistoryRaw) {
            console.log("Found old text-based history. Migrating...");
            try {
                const oldHistory = JSON.parse(oldHistoryRaw);
                if (Array.isArray(oldHistory)) {
                    const newHistory = [];
                    let newPRs = {};

                    oldHistory.forEach(entryText => {
                        const lines = entryText.split('\n');
                        const dateLine = lines.find(line => line.startsWith('üóìÔ∏è'));
                        if (!dateLine) return;
                        const date = parseThaiDate(dateLine);
                        if (!date) return;

                        const newEntry = {
                            id: date.toISOString().slice(0, 10),
                            isoDate: date.toISOString(),
                            dayName: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤',
                            totalVolume: 0,
                            duration: '00:00:00',
                            exercises: [],
                            prsAchieved: []
                        };

                        let currentExercise = null;
                        lines.forEach(line => {
                            const trimmedLine = line.trim();
                            if (trimmedLine.startsWith('‚ñ™Ô∏è')) {
                                if (currentExercise) newEntry.exercises.push(currentExercise);
                                const exName = trimmedLine.substring(2).replace("‚≠ê","").trim();
                                currentExercise = { name: exName, volume: 0, notes: '', sets: [], muscleGroup: getMuscleGroup(exName) };
                            } else if (currentExercise && trimmedLine.startsWith('- Set')) {
                                const parts = trimmedLine.match(/(\d+\.?\d*)kg x (\d+) reps(?: @RPE (\d+))?/);
                                if (parts) {
                                    const weight = parseFloat(parts[1]);
                                    const reps = parseInt(parts[2]);
                                    const rpe = parts[3] || '-';
                                    const newSet = { weight, reps, rpe, e1rm: calculate1RM(weight, reps) };
                                    currentExercise.sets.push(newSet);
                                    currentExercise.volume += weight * reps;
                                    newEntry.totalVolume += weight * reps;
                                }
                            } else if (currentExercise && trimmedLine.startsWith('üìù Notes:')) {
                                currentExercise.notes = trimmedLine.substring(9).trim();
                            }
                        });
                        if (currentExercise) newEntry.exercises.push(currentExercise);
                        
                        // Add duration if present
                        const durationLine = lines.find(line => line.includes('‚è±Ô∏è DURATION:'));
                        if (durationLine) newEntry.duration = durationLine.split(':')[1].trim();
                        
                        if (newEntry.exercises.length > 0) newHistory.push(newEntry);
                    });
                    
                    // Recalculate all PRs from the new history
                    newHistory.forEach(entry => {
                        entry.exercises.forEach(ex => {
                            ex.sets.forEach(set => {
                                const {name} = ex;
                                const {weight, reps} = set;
                                if (!newPRs[name]) newPRs[name] = { maxWeight: 0, repPRs: {} };
                                if (weight > newPRs[name].maxWeight) newPRs[name].maxWeight = weight;
                                if (!newPRs[name].repPRs[weight] || reps > newPRs[name].repPRs[weight]) newPRs[name].repPRs[weight] = reps;
                            });
                        });
                    });

                    localStorage.setItem('gymLogHistory_v2', JSON.stringify(newHistory));
                    localStorage.setItem('gymLogPRs_v4', JSON.stringify(newPRs));
                    localStorage.removeItem('gymLogHistory'); // Clean up old data
                    localStorage.removeItem('gymLogPRs');     // Clean up old data
                    migrationPerformed = true;
                    console.log("Old history migrated to new JSON format.");
                }
            } catch (e) {
                console.error("Failed to migrate old history:", e);
            }
        }
        
        // --- Migration for old plan format ---
        const oldPlansRaw = localStorage.getItem('gymWorkoutPlans');
        if (oldPlansRaw) {
             console.log("Found old plan format. Migrating...");
             try {
                const oldPlans = JSON.parse(oldPlansRaw);
                if (Array.isArray(oldPlans) && typeof oldPlans[0]?.days[0]?.exercises[0] === 'string') {
                    const newPlans = oldPlans.map(plan => ({
                        ...plan,
                        days: plan.days.map(day => ({
                            ...day,
                            exercises: day.exercises.map(exName => ({ name: exName, muscleGroup: getMuscleGroup(exName) }))
                        }))
                    }));
                    localStorage.setItem('gymWorkoutPlans_v3', JSON.stringify(newPlans));
                    localStorage.removeItem('gymWorkoutPlans');
                    migrationPerformed = true;
                    console.log("Old plans migrated to new format.");
                }
             } catch (e) {
                 console.error("Failed to migrate old plans:", e);
             }
        }

        if (migrationPerformed) {
            alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡∏¢‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        }
    }
    
    function renderPlanListView() { const view = document.getElementById("plan-editor-view"); view.innerHTML = `<h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ù‡∏∂‡∏Å</h2><div id="plan-list"></div><button class="action-btn secondary" onclick="createNewPlan()"><i data-feather="plus-circle"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà</button>`; const planListDiv = document.getElementById("plan-list"); workoutPlans.forEach((plan, planIndex) => { const card = document.createElement("div"); card.className = "card"; let daysHTML = plan.days.map((day, dayIndex) => `<div class="list-item"><span><strong>${day.name}</strong> (${day.exercises.length} ‡∏ó‡πà‡∏≤)</span><div class="btn-group"><button onclick="renderDayEditorView(${planIndex}, ${dayIndex})"><i data-feather="edit-2"></i></button></div></div>`).join(""); card.innerHTML = `<h3>${plan.name} ${plan.active ? "(‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà)" : ""}</h3>${daysHTML}<div class="btn-group" style="margin-top: 15px; display:flex; gap: 10px;">${plan.active ? "" : `<button class="action-btn success" onclick="setActivePlan(${planIndex})">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ</button>`}<button class="action-btn neutral" onclick="renamePlan(${planIndex})">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠</button><button class="btn-delete" onclick="deletePlan(${planIndex})"><i data-feather="trash-2"></i></button></div>`; planListDiv.appendChild(card); }); feather.replace(); }
    function renderDayEditorView(planIndex, dayIndex) { const view = document.getElementById("plan-editor-view"); const day = workoutPlans[planIndex].days[dayIndex]; let exercisesHTML = day.exercises.map((ex, exIndex) => `<div class="list-item"><span>${ex.name} <em style="font-size:0.8em; opacity:0.7;">(${muscleGroups[ex.muscleGroup] || 'N/A'})</em></span><div class="btn-group"><button onclick="moveExercise(${planIndex}, ${dayIndex}, ${exIndex}, -1)" ${exIndex === 0 ? "disabled" : ""}><i data-feather="arrow-up"></i></button><button onclick="moveExercise(${planIndex}, ${dayIndex}, ${exIndex}, 1)" ${exIndex === day.exercises.length - 1 ? "disabled" : ""}><i data-feather="arrow-down"></i></button><button class="btn-delete" onclick="deleteExercise(${planIndex}, ${dayIndex}, ${exIndex})"><i data-feather="trash-2"></i></button></div></div>`).join(""); let muscleGroupOptions = ''; for (const key in muscleGroups) { muscleGroupOptions += `<option value="${key}">${muscleGroups[key]}</option>`; } view.innerHTML = `<h2><span class="back-button" onclick="renderPlanListView()"><i data-feather="arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö</span><span class="editable-title" onclick="renameDay(${planIndex}, ${dayIndex})">${day.name}</span></h2><div class="card">${day.exercises.length > 0 ? exercisesHTML : '<p style="text-align:center; opacity:0.7;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>'}<div class="add-exercise-form" style="margin-top: 20px; flex-wrap: wrap;"><input type="text" id="new-exercise-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà..." style="flex-grow:2; min-width: 150px;"><select id="new-exercise-muscle-group" style="flex-grow:1; min-width: 120px;">${muscleGroupOptions}</select><button class="action-btn primary" onclick="addExercise(${planIndex}, ${dayIndex})" style="flex-grow:1;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡πà‡∏≤</button></div></div>`; feather.replace(); }
    function addExercise(planIndex, dayIndex) { const nameInput = document.getElementById("new-exercise-name"); const groupSelect = document.getElementById("new-exercise-muscle-group"); const newExName = nameInput.value.trim(); const newExGroup = groupSelect.value; if (newExName) { workoutPlans[planIndex].days[dayIndex].exercises.push({ name: newExName, muscleGroup: newExGroup }); saveData(); renderDayEditorView(planIndex, dayIndex); } }
    function createNewPlan() { const name = prompt("‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà:", "‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô"); if (name) { workoutPlans.push({ name: name, active: false, days: [{ name: "‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå", exercises: [] }, { name: "‡∏ß‡∏±‡∏ô‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£", exercises: [] }, { name: "‡∏ß‡∏±‡∏ô‡∏û‡∏∏‡∏ò", exercises: [] }, { name: "‡∏ß‡∏±‡∏ô‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ", exercises: [] }, { name: "‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå", exercises: [] }, { name: "‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå", exercises: [] }, { name: "‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå", exercises: [] }] }); saveData(); renderPlanListView(); } }
    function renamePlan(planIndex) { const newName = prompt("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°:", workoutPlans[planIndex].name); if (newName) { workoutPlans[planIndex].name = newName; saveData(); renderPlanListView(); } }
    function deletePlan(planIndex) { if (workoutPlans.length > 1) { if (confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏° "${workoutPlans[planIndex].name}"?`)) { workoutPlans.splice(planIndex, 1); if (workoutPlans.findIndex(p => p.active) === -1) { workoutPlans[0].active = true; activePlanIndex = 0; } saveData(); renderPlanListView(); setupTodayWorkout(); } } else { alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°"); } }
    function setActivePlan(planIndex) { workoutPlans.forEach((p, i) => p.active = i === planIndex); activePlanIndex = planIndex; saveData(); renderPlanListView(); setupTodayWorkout(); }
    function renameDay(planIndex, dayIndex) { const day = workoutPlans[planIndex].days[dayIndex]; const newName = prompt("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ô:", day.name); if (newName && newName.trim() !== '') { day.name = newName.trim(); saveData(); renderDayEditorView(planIndex, dayIndex); } }
    function deleteExercise(planIndex, dayIndex, exIndex) { workoutPlans[planIndex].days[dayIndex].exercises.splice(exIndex, 1); saveData(); renderDayEditorView(planIndex, dayIndex); }
    function moveExercise(planIndex, dayIndex, exIndex, direction) { const exercises = workoutPlans[planIndex].days[dayIndex].exercises; const newIndex = exIndex + direction; if (newIndex < 0 || newIndex >= exercises.length) return;[exercises[exIndex], exercises[newIndex]] = [exercises[newIndex], exercises[exIndex]]; saveData(); renderDayEditorView(planIndex, dayIndex); }
    
    function setupTodayWorkout(forceDayIndex = -1) { 
        try { currentSessionPRs = []; const today = new Date(); const smartAssistantBox = document.getElementById('smart-assistant-box'); smartAssistantBox.innerHTML = ''; const dayOfWeek = today.getDay(); let dayIndex = (forceDayIndex > -1) ? forceDayIndex : (dayOfWeek === 0 ? 6 : dayOfWeek - 1); if (forceDayIndex === -1) { const skippedDayInfo = checkForSkippedWorkouts(); if (skippedDayInfo && skippedDayInfo.skipped) { renderSkippedDaySuggestion(skippedDayInfo.lastDayName, skippedDayInfo.skippedDayName, skippedDayInfo.skippedDayIndex); return; } if (checkForDeloadSuggestion()) { renderDeloadSuggestion(); } } renderWorkoutForDay(dayIndex); } catch (error) { console.error("Error in setupTodayWorkout:", error); const exerciseList = document.getElementById('exercise-list'); exerciseList.innerHTML = `<p style="color:red; text-align:center;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ<br><i>${error.message}</i></p>`; } 
    }
    
    function renderRestDayCard(currentDayIndex) {
        const exerciseList = document.getElementById('exercise-list');
        const currentPlan = workoutPlans[activePlanIndex];
        let nextWorkoutDay = null;
        let nextDayIndex = (currentDayIndex + 1) % 7;
        
        for (let i = 0; i < 7; i++) {
            if (currentPlan.days[nextDayIndex] && currentPlan.days[nextDayIndex].exercises.length > 0) {
                nextWorkoutDay = currentPlan.days[nextDayIndex];
                break;
            }
            nextDayIndex = (nextDayIndex + 1) % 7;
        }

        if (!nextWorkoutDay) {
            exerciseList.innerHTML = '<p style="text-align:center; padding: 20px 0; font-size: 1.1em;">‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà! üßò</p>';
            return;
        }

        const history = JSON.parse(localStorage.getItem("gymLogHistory_v2") || "[]");
        let previewHTML = '';
        nextWorkoutDay.exercises.slice(0, 3).forEach(ex => {
            let lastPerformance = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            const lastEntry = history.find(entry => entry.exercises.some(e => e.name === ex.name));
            if (lastEntry) {
                const lastEx = lastEntry.exercises.find(e => e.name === ex.name);
                if (lastEx && lastEx.sets.length > 0) {
                    const topSet = lastEx.sets.reduce((a, b) => (a.weight > b.weight ? a : b));
                    lastPerformance = `‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${topSet.weight}kg x ${topSet.reps} reps`;
                }
            }
            previewHTML += `<div class="exercise-item"><i data-feather="target" class="feather"></i><span class="exercise-name">${ex.name}</span><span class="last-performance">${lastPerformance}</span></div>`;
        });

        exerciseList.innerHTML = `
            <div class="rest-day-card">
                <h2><i data-feather="calendar"></i> ‡∏ß‡∏±‡∏ô‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô</h2>
                <p>‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ!</p>
                <div class="next-workout-preview">
                    <h4>‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ${nextWorkoutDay.name}</h4>
                    ${previewHTML}
                </div>
            </div>
        `;
        feather.replace();
    }

    function renderWorkoutForDay(dayIndex) { if (workoutStartTime === null) { workoutStartTime = null; clearInterval(workoutTimerInterval); const durationDisplay = document.getElementById("total-duration-display"); if(durationDisplay) durationDisplay.textContent = ""; currentWorkoutLog = {}; } const currentPlan = workoutPlans[activePlanIndex]; if (!currentPlan || !currentPlan.days || !currentPlan.days[dayIndex]) { document.getElementById('workout-day-title').textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°"; document.getElementById('exercise-list').innerHTML = '<p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ "‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ù‡∏∂‡∏Å" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°</p>'; return; } const day = currentPlan.days[dayIndex]; const exerciseList = document.getElementById('exercise-list'); document.getElementById('workout-day-title').textContent = day.name; exerciseList.innerHTML = '';
        
        if (day.exercises.length === 0) {
            renderRestDayCard(dayIndex);
            return;
        }

        renderLastTimeSummary(day.exercises);

        day.exercises.forEach((ex) => { const exName = ex.name; if (currentWorkoutLog[exName]) return; currentWorkoutLog[exName] = { sets: [], notes: '', muscleGroup: ex.muscleGroup }; const suggestion = getProgressionSuggestion(exName); const history = JSON.parse(localStorage.getItem("gymLogHistory_v2") || "[]"); let lastSessionData = "‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: -"; const lastEntry = history.find(entry => entry.exercises.some(e => e.name === exName)); if (lastEntry) { const lastEx = lastEntry.exercises.find(e => e.name === exName); if (lastEx && lastEx.sets.length > 0) { const topSet = lastEx.sets.reduce((a, b) => (a.weight > b.weight ? a : b)); lastSessionData = `‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${topSet.weight}kg x ${topSet.reps} reps`; } } const uniqueId = `card-${exName.replace(/[^a-zA-Z0-9]/g, "")}-${Date.now()}`; const card = document.createElement('div'); card.className = 'card exercise-card'; card.id = uniqueId; card.innerHTML = `<div class="ex-header"><div class="ex-title-container"><div class="pr-star" id="pr-star-${uniqueId}"><i data-feather="star" class="feather" style="fill: var(--pr-color);"></i></div><div class="exercise-title">${exName}</div></div><div class="btn-group"><button onclick="copyLastWorkout('${exName.replace(/'/g, "\\'")}', '${uniqueId}')" title="‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î"><i data-feather="copy"></i></button><input type="checkbox" onchange="toggleComplete('${uniqueId}')"></div></div><div class="exercise-notes" style="margin-bottom: 5px;">${lastSessionData}</div><div id="logged-sets-${uniqueId}" style="margin-bottom: 15px;"></div><div class="feedback-container" id="feedback-${uniqueId}"></div><div class="log-input" style="align-items: center; margin-bottom: 10px;"><button class="util-btn" onclick="adjustWeight('${uniqueId}', -1.25)"><i data-feather="minus"></i></button><input type="number" placeholder="‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å" id="weight-${uniqueId}" value="${suggestion ? suggestion.suggestedWeight : ""}" style="width: 60px; text-align: center;"><button class="util-btn" onclick="adjustWeight('${uniqueId}', 1.25)"><i data-feather="plus"></i></button><button class="util-btn" onclick="openPlateCalculator('${uniqueId}')">‚öñÔ∏è</button><input type="number" placeholder="‡∏Ñ‡∏£‡∏±‡πâ‡∏á" id="reps-${uniqueId}" style="width: 60px; text-align: center;"><select id="rpe-${uniqueId}" style="width: 70px;"><option value="">RPE</option>${[10,9,8,7,6,5,4,3,2,1].map(v => `<option value="${v}">${v}</option>`).join('')}</select></div><button class="action-btn primary" onclick="logSetAndStartTimer('${uniqueId}', '${exName.replace(/'/g, "\\'")}')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ã‡πá‡∏ï & ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏±‡∏Å</button><textarea class="notes-input" id="notes-${uniqueId}" placeholder="‡∏à‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ó‡πà‡∏≤‡∏ô‡∏µ‡πâ..."></textarea>`; exerciseList.appendChild(card); if (personalRecords[exName] && personalRecords[exName].maxWeight > 0) { document.getElementById(`pr-star-${uniqueId}`).style.display = "inline"; } }); feather.replace(); }
    function showOverrideModal() { const listContainer = document.getElementById('override-list'); listContainer.innerHTML = ''; const currentPlan = workoutPlans[activePlanIndex]; currentPlan.days.forEach((day, index) => { const btn = document.createElement('button'); btn.className = 'action-btn secondary'; btn.textContent = day.name; btn.onclick = () => { closeModal('override-modal'); renderWorkoutForDay(index); }; listContainer.appendChild(btn); }); document.getElementById('override-modal').style.display = 'block'; feather.replace(); }
    
    function copyLastWorkout(exerciseName, cardId) { if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤ ${exerciseName} ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return; const history = JSON.parse(localStorage.getItem("gymLogHistory_v2") || "[]"); const lastEntry = history.find(entry => entry.exercises.some(ex => ex.name === exerciseName)); if (!lastEntry) { alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß"); return; } const lastEx = lastEntry.exercises.find(ex => ex.name === exerciseName); if (!lastEx || lastEx.sets.length === 0) { alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß"); return; } if (!workoutStartTime) { startWorkoutTimer(); } if (!currentWorkoutLog[exerciseName]) { currentWorkoutLog[exerciseName] = { sets: [], notes: '', muscleGroup: lastEx.muscleGroup || getMuscleGroup(exerciseName) }; } currentWorkoutLog[exerciseName].sets = JSON.parse(JSON.stringify(lastEx.sets)); saveWorkoutToHistory(); renderLoggedSets(exerciseName, cardId); const weightInput = document.getElementById(`weight-${cardId}`); const repsInput = document.getElementById(`reps-${cardId}`); if(lastEx.sets.length > 0){ weightInput.value = lastEx.sets[lastEx.sets.length - 1].weight; repsInput.value = lastEx.sets[lastEx.sets.length - 1].reps; } }
    function checkForSkippedWorkouts() { const history = JSON.parse(localStorage.getItem('gymLogHistory_v2') || '[]'); if (history.length === 0) return { skipped: false }; const lastEntry = history[0]; const lastDate = new Date(lastEntry.isoDate); const today = new Date(); today.setHours(0, 0, 0, 0); lastDate.setHours(0, 0, 0, 0); const diffTime = today - lastDate; const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); if (diffDays > 1 && diffDays < 7) { const lastDayOfWeek = lastDate.getDay(); const lastDayIndex = lastDayOfWeek === 0 ? 6 : lastDayOfWeek - 1; for (let i = 1; i < diffDays; i++) { const skippedDayIndex = (lastDayIndex + i) % 7; const skippedDay = workoutPlans[activePlanIndex].days[skippedDayIndex]; if (skippedDay && skippedDay.exercises.length > 0) { return { skipped: true, skippedDayIndex: skippedDayIndex, skippedDayName: skippedDay.name, lastDayName: workoutPlans[activePlanIndex].days[lastDayIndex].name }; } } } return { skipped: false }; }
    function renderSkippedDaySuggestion(lastDayName, skippedDayName, skippedDayIndex) { const todayDayIndex = (new Date().getDay() === 0) ? 6 : new Date().getDay() - 1; const todayDayName = workoutPlans[activePlanIndex].days[todayDayIndex].name; const box = document.getElementById('smart-assistant-box'); box.innerHTML = `<div class="suggestion-card"><h3>üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢</h3><p>‡∏î‡∏π‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÄ‡∏•‡πà‡∏ô '${lastDayName}' ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å '${skippedDayName}' ‡πÑ‡∏õ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£?</p><button class="action-btn primary" onclick="document.getElementById('smart-assistant-box').innerHTML = ''; setupTodayWorkout(${todayDayIndex})">‡∏ó‡∏≥‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (${todayDayName})</button><button class="action-btn secondary" onclick="document.getElementById('smart-assistant-box').innerHTML = ''; setupTodayWorkout(${skippedDayIndex})">‡∏ó‡∏≥‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ (${skippedDayName})</button></div>`; document.getElementById('exercise-list').innerHTML = ''; feather.replace(); }
    function checkForDeloadSuggestion() { const history = JSON.parse(localStorage.getItem("gymLogHistory_v2") || "[]"); if (history.length < 3) return false; const mainLifts = new Set(workoutPlans[activePlanIndex].days.map(d => d.exercises[0]?.name).filter(Boolean)); let stallCount = 0; mainLifts.forEach(lift => { const liftHistory = history.filter(h => h.exercises.some(ex => ex.name === lift)); if (liftHistory.length >= 3) { const vol1 = liftHistory[0].exercises.find(ex => ex.name === lift)?.volume || 0; const vol2 = liftHistory[1].exercises.find(ex => ex.name === lift)?.volume || 0; const vol3 = liftHistory[2].exercises.find(ex => ex.name === lift)?.volume || 0; if (vol1 <= vol2 && vol2 <= vol3) stallCount++; } }); return stallCount >= 1; }
    function renderDeloadSuggestion() { const box = document.getElementById('smart-assistant-box'); box.innerHTML = `<div class="suggestion-card" style="border-color: var(--danger-color); background-color: rgba(244, 67, 54, 0.1);"><h3>üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏ä</h3><p>‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡∏ß‡πà‡∏≤ Volume ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏î‡∏•‡∏á‡∏°‡∏≤‡∏™‡∏±‡∏Å‡∏û‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏Å‡∏ü‡∏∑‡πâ‡∏ô ‡∏•‡∏≠‡∏á‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏ó‡∏≥ Deload Week ‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ‡∏î‡∏π‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö (‡∏•‡∏î‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ã‡πá‡∏ï‡∏•‡∏á‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á)</p></div>`; }
    function getProgressionSuggestion(exerciseName) { const history = JSON.parse(localStorage.getItem("gymLogHistory_v2") || "[]"); const lastEntry = history.find(entry => entry.exercises.some(ex => ex.name === exerciseName)); if (lastEntry) { const lastEx = lastEntry.exercises.find(ex => ex.name === exerciseName); if (lastEx && lastEx.sets.length > 0) { const topSet = lastEx.sets.reduce((a, b) => (a.weight >= b.weight ? a : b)); if (topSet.reps >= 12 && parseInt(topSet.rpe) <= 8) return { suggestedWeight: topSet.weight + 2.5 }; if (topSet.reps < 8 && parseInt(topSet.rpe) > 8) return { suggestedWeight: topSet.weight - 2.5 }; return { suggestedWeight: topSet.weight }; } } return null; }
    function toggleQuickLogForm() { const form = document.getElementById('quick-log-form'); const btn = document.getElementById('toggle-quick-log-btn'); if (form.style.display === 'none') { form.style.display = 'block'; btn.innerHTML = '<i data-feather="x"></i>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πà‡∏ß‡∏ô'; btn.classList.remove('neutral'); btn.classList.add('danger'); } else { form.style.display = 'none'; btn.innerHTML = '<i data-feather="zap"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πà‡∏ß‡∏ô (Freestyle)'; btn.classList.remove('danger'); btn.classList.add('neutral'); } feather.replace(); }
    function saveQuickLog() { const exerciseName = document.getElementById('quick-log-exercise').value.trim(); const muscleGroup = document.getElementById('quick-log-muscle-group').value; const weightStr = document.getElementById('quick-log-weight').value; const repsStr = document.getElementById('quick-log-reps').value; if (!exerciseName || !weightStr || !repsStr) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á"); return; } const weight = parseFloat(weightStr); const reps = parseInt(repsStr); if (isNaN(weight) || isNaN(reps)) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç"); return; } if (!currentWorkoutLog[exerciseName]) { currentWorkoutLog[exerciseName] = { sets: [], notes: '', muscleGroup: muscleGroup }; } const estimated1RM = calculate1RM(weight, reps); const newSet = { weight: weight, reps: reps, rpe: "-", e1rm: estimated1RM }; checkAndSavePR(exerciseName, weight, reps); currentWorkoutLog[exerciseName].sets.push(newSet); if (!workoutStartTime) { startWorkoutTimer(); } saveWorkoutToHistory(); renderFreestyleLog(exerciseName, newSet); document.getElementById('quick-log-exercise').value = ''; document.getElementById('quick-log-weight').value = ''; document.getElementById('quick-log-reps').value = ''; toggleQuickLogForm(); }
    function showPage(pageName) { document.querySelectorAll(".page, .tab-button").forEach(el => el.classList.remove("active")); document.getElementById(pageName).classList.add("active"); document.querySelector(`.tab-button[onclick="showPage('${pageName}')"]`).classList.add("active"); if (pageName === 'plans') { renderPlanListView() } if (pageName === 'prs') { renderPRsPage() } if (pageName === 'analysis') { renderAnalysisPage() } if (pageName === 'body') { renderBodyStatsPage() } if (pageName === 'settings') { updateEquipmentInputs() } if (pageName === 'history') { loadHistory(); filterHistory(); } feather.replace(); }
    function toggleComplete(cardId){document.getElementById(cardId).classList.toggle("completed")}
    function calculate1RM(weight, reps) { if (reps == 1) return weight; if (reps <= 0) return 0; return weight * (1 + (reps / 30)); }
    function adjustWeight(cardId, amount) { const weightInput = document.getElementById(`weight-${cardId}`); let currentWeight = parseFloat(weightInput.value) || 0; let newWeight = currentWeight + amount; if (newWeight < 0) newWeight = 0; weightInput.value = newWeight; }
    function renderLoggedSets(exerciseName, cardId) { const loggedSetsContainer = document.getElementById(`logged-sets-${cardId}`); if(!loggedSetsContainer) return; loggedSetsContainer.innerHTML = ''; if (!currentWorkoutLog[exerciseName] || !currentWorkoutLog[exerciseName].sets) return; currentWorkoutLog[exerciseName].sets.forEach((set, setIndex) => { const setItem = document.createElement("div"); setItem.className = 'list-item history-set-item'; setItem.style.padding = '8px'; setItem.innerHTML = `<div class="set-item-details"><span>Set ${setIndex + 1}: ${set.weight}kg x ${set.reps} reps @RPE ${set.rpe}</span><span class="estimated-1rm">1RM ‚âà ${set.e1rm.toFixed(1)} kg</span></div><button class="btn-delete" onclick="deleteSet('${exerciseName.replace(/'/g, "\\'")}', '${cardId}', ${setIndex})"><i data-feather="trash-2"></i></button>`; loggedSetsContainer.appendChild(setItem); }); feather.replace(); }
    function deleteSet(exerciseName, cardId, setIndex) { if (confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏•‡∏ö Set ${setIndex + 1} ‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤ ${exerciseName}?`)) { if(currentWorkoutLog[exerciseName]) { currentWorkoutLog[exerciseName].sets.splice(setIndex, 1); saveWorkoutToHistory(); renderLoggedSets(exerciseName, cardId); recalculatePRs(exerciseName); } } }
    function displayRpeFeedback(cardId, message) { const feedbackContainer = document.getElementById(`feedback-${cardId}`); if(feedbackContainer){ feedbackContainer.innerHTML = `<p class="feedback-message">${message}</p>`; setTimeout(() => { feedbackContainer.innerHTML = ''; }, 8000); } }
    function logSetAndStartTimer(cardId, exerciseName) { if (!workoutStartTime) { startWorkoutTimer(); } const weightInput = document.getElementById(`weight-${cardId}`); const repsInput = document.getElementById(`reps-${cardId}`); const rpeInput = document.getElementById(`rpe-${cardId}`); const weight = parseFloat(weightInput.value) || 0; const reps = parseInt(repsInput.value); const rpe = rpeInput.value; if (!reps || isNaN(reps) || reps <= 0) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); repsInput.focus(); return; } const prData = personalRecords[exerciseName]; if (prData && weight > prData.maxWeight * 1.20) { if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÉ‡∏´‡∏°‡πà!\n\n‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å ${weight}kg ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏£‡∏≠‡∏Å ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏î‡∏¥‡∏° (${prData.maxWeight}kg) ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡∏Å ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á?`)) return; } const prMessages = checkAndSavePR(exerciseName, weight, reps); if (prMessages) { displayRpeFeedback(cardId, prMessages); vibrate(100); } const estimated1RM = calculate1RM(weight, reps); const logData = { weight: weight, reps: reps, rpe: rpe || "-", e1rm: estimated1RM }; if (!currentWorkoutLog[exerciseName]) { currentWorkoutLog[exerciseName] = { sets: [], notes: '', muscleGroup: 'Other' }; } currentWorkoutLog[exerciseName].sets.push(logData); renderLoggedSets(exerciseName, cardId); repsInput.value = ""; rpeInput.value = ""; repsInput.focus(); saveWorkoutToHistory(); startTimer(); }
    
    function saveWorkoutToHistory() {
        let history = JSON.parse(localStorage.getItem("gymLogHistory_v2") || "[]");
        const today = new Date();
        const todayId = today.toISOString().slice(0, 10);
        
        let totalVolume = 0;
        const exercisesData = [];
        
        document.querySelectorAll('.exercise-card').forEach(card => {
            const titleEl = card.querySelector('.exercise-title');
            if (!titleEl) return;
            const exName = titleEl.textContent;
            if (currentWorkoutLog[exName] && currentWorkoutLog[exName].sets.length > 0) {
                const exLog = currentWorkoutLog[exName];
                const notesInput = card.querySelector('.notes-input');
                const notes = notesInput ? notesInput.value : '';
                const exerciseVolume = exLog.sets.reduce((sum, set) => sum + (set.weight * set.reps), 0);
                
                if (!exercisesData.some(ex => ex.name === exName)) {
                    exercisesData.push({ 
                        name: exName, 
                        volume: exerciseVolume, 
                        notes: notes, 
                        sets: exLog.sets, 
                        muscleGroup: exLog.muscleGroup 
                    });
                    totalVolume += exerciseVolume;
                }
            }
        });
        
        if (exercisesData.length === 0) {
             const todayIndex = history.findIndex(entry => entry.id === todayId);
             if (todayIndex > -1) {
                const deletedExercises = history[todayIndex].exercises;
                history.splice(todayIndex, 1);
                localStorage.setItem("gymLogHistory_v2", JSON.stringify(history));
                deletedExercises.forEach(ex => recalculatePRs(ex.name));
            }
            return; 
        }

        let durationStr = "00:00:00";
        if (workoutStartTime) {
            const elapsed = Math.floor((Date.now() - workoutStartTime) / 1000);
            const h = Math.floor(elapsed / 3600).toString().padStart(2, '0');
            const m = Math.floor(elapsed % 3600 / 60).toString().padStart(2, '0');
            const s = Math.floor(elapsed % 60).toString().padStart(2, '0');
            durationStr = `${h}:${m}:${s}`;
        }

        const newEntry = {
            id: todayId,
            isoDate: today.toISOString(),
            dayName: document.getElementById('workout-day-title').textContent,
            totalVolume: totalVolume,
            duration: durationStr,
            exercises: exercisesData,
            prsAchieved: currentSessionPRs
        };

        const todayIndex = history.findIndex(entry => entry.id === todayId);
        if (todayIndex > -1) {
            history[todayIndex] = newEntry;
        } else {
            history.unshift(newEntry);
        }
        localStorage.setItem("gymLogHistory_v2", JSON.stringify(history));
    }

    function loadHistory() { const historyContainer = document.getElementById("history-container"); historyContainer.innerHTML = ""; const history = JSON.parse(localStorage.getItem("gymLogHistory_v2") || "[]"); if (history.length === 0) { historyContainer.innerHTML = "<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å</p>"; return; } const groupedByMonth = history.reduce((acc, entry, index) => { const date = new Date(entry.isoDate); const monthYear = date.toLocaleDateString("th-TH", { year: "numeric", month: "long" }); if (!acc[monthYear]) acc[monthYear] = []; acc[monthYear].push({ ...entry, originalIndex: index }); return acc; }, {}); Object.keys(groupedByMonth).sort((a,b) => new Date(b.split(" ")[1], ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå","‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°","‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô","‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°","‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô","‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°","‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô","‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°","‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô","‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"].indexOf(b.split(" ")[0])) - new Date(a.split(" ")[1], ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå","‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°","‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô","‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°","‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô","‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°","‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô","‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°","‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô","‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"].indexOf(a.split(" ")[0]))).forEach(month => { const monthDiv = document.createElement("div"); monthDiv.className = 'month-container'; monthDiv.innerHTML = `<h3>${month}</h3>`; groupedByMonth[month].forEach(entry => { const entryCard = document.createElement("div"); entryCard.className = "card"; entryCard.id = `history-card-${entry.originalIndex}`; const date = new Date(entry.isoDate); const dateString = date.toLocaleDateString("th-TH", { weekday: 'long', day: 'numeric' }); let exercisesHTML = entry.exercises.map((ex, exIndex) => { const safeExName = ex.name.replace(/'/g, "\\'").replace(/"/g, '&quot;'); const maxWeightSet = ex.sets.reduce((max, set) => set.weight > max.weight ? set : max, {weight: 0}); const isWeightPR = (entry.prsAchieved || []).some(pr => pr.type === 'weight' && pr.exercise === ex.name && pr.weight === maxWeightSet.weight); return `<div id="history-ex-${entry.originalIndex}-${exIndex}"><div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;"><div class="history-exercise-title ${isWeightPR ? 'pr-highlight' : ''}" onclick="viewAnalysisFor('${safeExName}')">‚ñ™Ô∏è ${ex.name} ${isWeightPR ? '‚≠ê' : ''}</div><button class="btn-delete" onclick="toggleSetDetails(${entry.originalIndex}, ${exIndex})"><i data-feather="menu"></i></button></div><div id="set-details-${entry.originalIndex}-${exIndex}" style="display:none; margin-left: 15px; margin-top: 5px;">${ex.sets.map((set, setIndex) => { const isRepPR = (entry.prsAchieved || []).some(pr => pr.type === 'reps' && pr.exercise === ex.name && pr.weight === set.weight && pr.reps === set.reps); return `<div class="history-set-item history-details-grid ${isRepPR ? 'pr-highlight' : ''}"><span>Set ${setIndex + 1}: ${set.weight}kg x ${set.reps} reps @${set.rpe} ${isRepPR ? '‚≠ê' : ''}</span><span class="estimated-1rm">1RM‚âà${set.e1rm.toFixed(1)}kg</span><button class="btn-delete" onclick="deleteSetFromHistory(${entry.originalIndex}, ${exIndex}, ${setIndex})"><i data-feather="trash-2"></i></button></div>`}).join('')} ${ex.notes ? `<p style="font-size: 0.9em; opacity: 0.8; margin-top: 5px;">üìù ${ex.notes}</p>` : ''}<button class="action-btn danger" onclick="deleteExerciseFromHistory(${entry.originalIndex}, ${exIndex})" style="width:100%; margin-top:10px; font-size: 0.9em; padding: 8px;"><i data-feather="trash"></i> ‡∏•‡∏ö‡∏ó‡πà‡∏≤ ${ex.name} ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button></div></div>`}).join(''); entryCard.innerHTML = `<button class="btn-delete" onclick="deleteHistoryEntry(${entry.originalIndex})" style="position: absolute; top: 15px; right: 15px;"><i data-feather="x-circle" style="color:var(--danger-color);"></i></button><h4 style="color: var(--text-color); margin: 0 0 10px 0;">${dateString}</h4><div style="font-size: 0.9em; color: var(--text-secondary-color);">‚è±Ô∏è ${entry.duration} &nbsp; üî• ${entry.totalVolume.toFixed(0)} kg</div><hr style="border-color: var(--border-color); opacity: 0.5; margin: 15px 0;">${exercisesHTML}`; monthDiv.appendChild(entryCard); }); historyContainer.appendChild(monthDiv); }); feather.replace(); }
    function filterHistory() { const searchTerm = document.getElementById('history-search').value.toLowerCase(); const historyContainer = document.getElementById('history-container'); const monthContainers = historyContainer.querySelectorAll('.month-container'); monthContainers.forEach(monthContainer => { const entryCards = monthContainer.querySelectorAll('.card'); let monthHasVisibleEntries = false; entryCards.forEach(card => { const cardText = card.textContent.toLowerCase(); if (cardText.includes(searchTerm)) { card.style.display = 'block'; monthHasVisibleEntries = true; } else { card.style.display = 'none'; } }); monthContainer.style.display = monthHasVisibleEntries ? 'block' : 'none'; }); }
    function toggleSetDetails(historyIndex, exIndex) { const detailsDiv = document.getElementById(`set-details-${historyIndex}-${exIndex}`); detailsDiv.style.display = detailsDiv.style.display === 'none' ? 'block' : 'none'; }
    function deleteHistoryEntry(index) { if (confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ")) { let history = JSON.parse(localStorage.getItem("gymLogHistory_v2") || "[]"); const entryToDelete = history[index]; if (index >= 0 && index < history.length) { history.splice(index, 1); localStorage.setItem("gymLogHistory_v2", JSON.stringify(history)); entryToDelete.exercises.forEach(ex => recalculatePRs(ex.name)); loadAllData(); renderAllPages(); alert("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); } else { alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ: Index ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); } } }
    function deleteExerciseFromHistory(historyIndex, exerciseIndex) { let history = JSON.parse(localStorage.getItem("gymLogHistory_v2") || "[]"); const entry = history[historyIndex]; const exerciseToDelete = entry.exercises[exerciseIndex]; if (confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡πà‡∏≤ "${exerciseToDelete.name}" ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ?`)) { const deletedVolume = exerciseToDelete.volume; entry.exercises.splice(exerciseIndex, 1); entry.totalVolume -= deletedVolume; if(entry.exercises.length === 0) { history.splice(historyIndex, 1); } else { history[historyIndex] = entry; } localStorage.setItem("gymLogHistory_v2", JSON.stringify(history)); recalculatePRs(exerciseToDelete.name); loadAllData(); renderAllPages(); } }
    function deleteSetFromHistory(historyIndex, exerciseIndex, setIndex) { let history = JSON.parse(localStorage.getItem("gymLogHistory_v2") || "[]"); const entry = history[historyIndex]; const exercise = entry.exercises[exerciseIndex]; const setToDelete = exercise.sets[setIndex]; if (confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö Set ${setIndex + 1} (${setToDelete.weight}kg x ${setToDelete.reps} reps) ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡πà‡∏≤ ${exercise.name}?`)) { const deletedSetVolume = setToDelete.weight * setToDelete.reps; exercise.volume -= deletedSetVolume; entry.totalVolume -= deletedSetVolume; exercise.sets.splice(setIndex, 1); if(exercise.sets.length === 0) { entry.exercises.splice(exerciseIndex, 1); } if(entry.exercises.length === 0) { history.splice(historyIndex, 1); } else { history[historyIndex] = entry; } localStorage.setItem("gymLogHistory_v2", JSON.stringify(history)); recalculatePRs(exercise.name); loadAllData(); renderAllPages(); } }
    function viewAnalysisFor(exerciseName) { showPage('analysis'); const select = document.getElementById('exercise-select'); select.value = exerciseName; generateExerciseCharts(exerciseName); }
    function showWorkoutSummary() { saveWorkoutToHistory(); vibrate(100); const history = JSON.parse(localStorage.getItem("gymLogHistory_v2") || "[]"); const todayId = new Date().toISOString().slice(0, 10); const todayEntry = history.find(entry => entry.id === todayId); if (!todayEntry) { alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ã‡πá‡∏ï‡πÉ‡∏î‡πÜ"); return; } document.getElementById('summary-volume').textContent = `${todayEntry.totalVolume.toFixed(0)} kg`; document.getElementById('summary-duration').textContent = todayEntry.duration; const totalSets = todayEntry.exercises.reduce((sum, ex) => sum + ex.sets.length, 0); document.getElementById('summary-sets').textContent = totalSets; const prsContainer = document.getElementById('summary-prs-container'); const prsList = document.getElementById('summary-prs-list'); prsList.innerHTML = ''; const newPRs = todayEntry.prsAchieved || []; if (newPRs.length > 0) { newPRs.forEach(pr => { const li = document.createElement('li'); if (pr.type === 'weight') { li.innerHTML = `<strong>${pr.exercise}</strong> - ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà ${pr.weight} kg!`; } else { li.innerHTML = `<strong>${pr.exercise}</strong> - ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà ${pr.weight} kg (${pr.reps} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)`; } prsList.appendChild(li); }); prsContainer.style.display = 'block'; } else { prsContainer.style.display = 'none'; } document.getElementById('summary-modal').style.display = 'block'; }
    function renderPRsPage() { const container = document.getElementById('pr-list-container'); container.innerHTML = ''; if (Object.keys(personalRecords).length === 0) { container.innerHTML = '<p style="text-align:center; padding: 20px; opacity:0.7;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥<br/>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÉ‡∏´‡∏°‡πà (PR) ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>'; return; } const sortedPRs = Object.entries(personalRecords).sort((a, b) => a[0].localeCompare(b[0])); sortedPRs.forEach(([exerciseName, prData]) => { const prItem = document.createElement('div'); prItem.className = 'pr-item'; prItem.innerHTML = `<div class="pr-item-header"><span class="pr-exercise-name">${exerciseName}</span><span class="pr-weight">${prData.maxWeight} kg</span></div><div class="rep-pr-details"><table class="rep-pr-table"><thead><tr><th>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (kg)</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</th></tr></thead><tbody>${Object.entries(prData.repPRs).sort((a, b) => parseFloat(b[0]) - parseFloat(a[0])).map(([weight, reps]) => `<tr><td>${weight}</td><td>${reps}</td></tr>`).join('')}</tbody></table></div>`; prItem.addEventListener('click', () => prItem.classList.toggle('open')); container.appendChild(prItem); }); feather.replace(); }
    function renderLastTimeSummary(dayExercises) { const summaryContainer = document.getElementById('last-time-summary'); const contentDiv = document.getElementById('last-time-content'); const history = JSON.parse(localStorage.getItem("gymLogHistory_v2") || "[]"); const dayExerciseNames = dayExercises.map(ex => ex.name); const lastEntry = history.find(entry => entry.exercises.some(ex => dayExerciseNames.includes(ex.name))); if (!lastEntry) { summaryContainer.style.display = 'none'; return; } let summaryHTML = ''; dayExercises.slice(0, 3).forEach(exObj => { const lastEx = lastEntry.exercises.find(ex => ex.name === exObj.name); if (lastEx && lastEx.sets.length > 0) { const topSet = lastEx.sets.reduce((a, b) => (a.weight >= b.weight ? a : b)); summaryHTML += `<p>${exObj.name}: <strong>${topSet.weight}kg x ${topSet.reps} reps</strong></p>`; } }); if (summaryHTML) { contentDiv.innerHTML = summaryHTML; summaryContainer.style.display = 'block'; } else { summaryContainer.style.display = 'none'; } }
    function renderFreestyleLog(exerciseName, setData) { const exerciseList = document.getElementById('exercise-list'); const cardId = `card-freestyle-${exerciseName.replace(/[^a-zA-Z0-9]/g, "")}`; let card = document.getElementById(cardId); if (!card) { card = document.createElement('div'); card.className = 'card exercise-card freestyle'; card.id = cardId; card.innerHTML = `<div class="ex-header"><div class="ex-title-container"><div class="exercise-title">${exerciseName} (Freestyle)</div></div></div><div id="logged-sets-${cardId}" style="margin-bottom: 15px;"></div>`; exerciseList.insertBefore(card, exerciseList.firstChild); } const loggedSetsContainer = document.getElementById(`logged-sets-${cardId}`); const setItem = document.createElement("div"); setItem.className = 'list-item history-set-item'; setItem.style.padding = '8px'; setItem.innerHTML = `<div class="set-item-details"><span>Set ${currentWorkoutLog[exerciseName].sets.length}: ${setData.weight}kg x ${setData.reps} reps</span><span class="estimated-1rm">1RM ‚âà ${setData.e1rm.toFixed(1)} kg</span></div><button class="btn-delete" onclick="deleteSet('${exerciseName.replace(/'/g, "\\'")}', '${cardId}', ${currentWorkoutLog[exerciseName].sets.length - 1})"><i data-feather="trash-2"></i></button>`; loggedSetsContainer.appendChild(setItem); feather.replace(); }
    function populateExerciseSelect(){ const history = JSON.parse(localStorage.getItem("gymLogHistory_v2") || "[]"); const exerciseSet = new Set; history.forEach(entry => entry.exercises.forEach(ex => exerciseSet.add(ex.name))); const select = document.getElementById("exercise-select"); if(!select)return; select.innerHTML='<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡πà‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ --</option>', Array.from(exerciseSet).sort().forEach(ex=>{ const option=document.createElement("option"); option.value=ex,option.textContent=ex,select.appendChild(option) }); }
    function renderAnalysisPage() { populateExerciseSelect(); generateMuscleBalanceChart(); generateExerciseCharts(document.getElementById('exercise-select').value); }
    function generateMuscleBalanceChart() { if (muscleBalanceChart) { muscleBalanceChart.destroy(); } const history = JSON.parse(localStorage.getItem("gymLogHistory_v2") || "[]"); const thirtyDaysAgo = new Date(); thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30); const volumeByGroup = Object.keys(muscleGroups).reduce((acc, key) => ({...acc, [key]: 0}), {}); history.filter(entry => new Date(entry.isoDate) > thirtyDaysAgo).forEach(entry => { entry.exercises.forEach(ex => { const group = ex.muscleGroup || getMuscleGroup(ex.name); if(volumeByGroup.hasOwnProperty(group)) { volumeByGroup[group] += ex.volume; } }); }); const ctx = document.getElementById('muscleBalanceChart').getContext('2d'); const labels = Object.keys(volumeByGroup); const data = Object.values(volumeByGroup); muscleBalanceChart = new Chart(ctx, { type: 'radar', data: { labels: labels.map(l => muscleGroups[l] || l), datasets: [{ label: 'Volume Distribution', data: data, backgroundColor: 'rgba(187, 134, 252, 0.2)', borderColor: 'rgba(187, 134, 252, 1)', pointBackgroundColor: 'rgba(187, 134, 252, 1)', }] }, options: { responsive: true, maintainAspectRatio: true, scales: { r: { angleLines: { color: 'rgba(255, 255, 255, 0.2)' }, grid: { color: 'rgba(255, 255, 255, 0.2)' }, pointLabels: { color: '#E0E0E0', font: { size: 12 } }, ticks: { display: false } } }, plugins: { legend: { display: false } } } }); }
    function populateMuscleGroupSelects() { const selects = document.querySelectorAll('#quick-log-muscle-group'); let optionsHTML = ''; for (const key in muscleGroups) { optionsHTML += `<option value="${key}">${muscleGroups[key]}</option>`; } selects.forEach(select => select.innerHTML = optionsHTML); }
    function generateExerciseCharts(exerciseName) { const container = document.getElementById('exercise-analysis-content'); if (chartVolume) { chartVolume.destroy() } if (chartStrength) { chartStrength.destroy() } if (!exerciseName) { container.innerHTML = ""; return; } container.innerHTML = `<div class="chart-container"><h3>Total Volume (kg)</h3><canvas id="chartVolume"></canvas></div><div class="chart-container"><h3>Estimated 1RM Progression (kg)</h3><canvas id="chartStrength"></canvas></div>`; const history = JSON.parse(localStorage.getItem("gymLogHistory_v2") || "[]"); const data = { labels: [], volumes: [], max1RMs: [] }; history.slice().reverse().forEach(entry => { const exData = entry.exercises.find(ex => ex.name === exerciseName); if (exData) { const date = new Date(entry.isoDate).toLocaleDateString("th-TH", { month: "short", day: "numeric" }); const max1RM = Math.max(...exData.sets.map(s => s.e1rm), 0); data.labels.push(date); data.volumes.push(exData.volume); data.max1RMs.push(max1RM); } }); const ctxVolume = document.getElementById("chartVolume").getContext("2d"); chartVolume = new Chart(ctxVolume, { type: "bar", data: { labels: data.labels, datasets: [{ label: "Total Volume (kg)", data: data.volumes, backgroundColor: "rgba(3, 218, 198, 0.5)", borderColor: "rgba(3, 218, 198, 1)", borderWidth: 1 }] }, options: { plugins: { legend: { display: !1 } }, scales: { y: { beginAtZero: !0 } } } }); const ctxStrength = document.getElementById("chartStrength").getContext("2d"); chartStrength = new Chart(ctxStrength, { type: "line", data: { labels: data.labels, datasets: [{ label: "Estimated 1RM (kg)", data: data.max1RMs, borderColor: "rgba(187, 134, 252, 1)", tension: .1 }] }, options: { plugins: { legend: { display: !1 } }, scales: { y: { beginAtZero: !1 } } } }); }
    function checkAndSavePR(exerciseName, weight, reps) { if (!personalRecords[exerciseName]) { personalRecords[exerciseName] = { maxWeight: 0, repPRs: {} }; } const prData = personalRecords[exerciseName]; let message = ''; let newWeightPR = false; let newRepPR = false; if (weight > prData.maxWeight) { newWeightPR = true; prData.maxWeight = weight; message += `‚≠ê ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà: ${weight}kg! `; currentSessionPRs.push({type: 'weight', exercise: exerciseName, weight: weight}); } if (!prData.repPRs[weight] || reps > prData.repPRs[weight]) { newRepPR = true; prData.repPRs[weight] = reps; message += `‚≠ê ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà ${weight}kg: ${reps} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á!`; currentSessionPRs.push({type: 'reps', exercise: exerciseName, weight: weight, reps: reps}); } if (newWeightPR || newRepPR) { localStorage.setItem("gymLogPRs_v4", JSON.stringify(personalRecords)); renderPRsPage(); const exCard = Array.from(document.querySelectorAll('.exercise-card')).find(card => card.querySelector('.exercise-title')?.textContent === exerciseName); if (exCard) { const star = exCard.querySelector('.pr-star'); if (star) star.style.display = 'inline'; } } return message || null; }
    function recalculatePRs(exerciseName) { const history = JSON.parse(localStorage.getItem("gymLogHistory_v2") || "[]"); const newPRData = { maxWeight: 0, repPRs: {} }; history.forEach(entry => { entry.exercises.forEach(ex => { if (ex.name === exerciseName) { ex.sets.forEach(set => { if (set.weight > newPRData.maxWeight) { newPRData.maxWeight = set.weight; } if (!newPRData.repPRs[set.weight] || set.reps > newPRData.repPRs[set.weight]) { newPRData.repPRs[set.weight] = set.reps; } }); } }); }); if (newPRData.maxWeight > 0) { personalRecords[exerciseName] = newPRData; } else { delete personalRecords[exerciseName]; } localStorage.setItem("gymLogPRs_v4", JSON.stringify(personalRecords)); renderPRsPage(); }
    function startWorkoutTimer(){if(workoutStartTime)return;workoutStartTime=Date.now();const e=document.getElementById("total-duration-display");workoutTimerInterval=setInterval(()=>{const t=Math.floor((Date.now()-workoutStartTime)/1e3),a=Math.floor(t/3600),n=Math.floor(t%3600/60),o=Math.floor(t%60);e.textContent=`${a.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`},1e3)}
    function startTimer(){vibrate(); clearInterval(timerInterval),timeRemaining=DEFAULT_REST_TIME,document.getElementById("rest-timer").style.display="flex",updateTimerDisplay(),timerInterval=setInterval(()=>{timeRemaining--,updateTimerDisplay(),timeRemaining<=0&&(stopTimer(),playBeep())},1e3)}
    function stopTimer(){clearInterval(timerInterval),document.getElementById("rest-timer").style.display="none"}
    function adjustTimer(seconds){timeRemaining+=seconds,timeRemaining<0&&(timeRemaining=0),updateTimerDisplay()}
    function updateTimerDisplay(){const minutes=Math.floor(timeRemaining/60),seconds=timeRemaining%60;document.getElementById("timer-display").textContent=`${minutes}:${seconds.toString().padStart(2,"0")}`}
    function playBeep(){if(!audioContext)return;const oscillator=audioContext.createOscillator(),gainNode=audioContext.createGain();oscillator.connect(gainNode),gainNode.connect(audioContext.destination),oscillator.type="sine",oscillator.frequency.setValueAtTime(880,audioContext.currentTime),gainNode.gain.setValueAtTime(.5,audioContext.currentTime),gainNode.gain.exponentialRampToValueAtTime(.001,audioContext.currentTime+1),oscillator.start(audioContext.currentTime),oscillator.stop(audioContext.currentTime+.5)}
    const bodyStatMetrics={weight:"‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏±‡∏ß (kg)",bf:"% ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô",chest:"‡∏£‡∏≠‡∏ö‡∏≠‡∏Å (cm)",waist:"‡∏£‡∏≠‡∏ö‡πÄ‡∏≠‡∏ß (cm)",arm:"‡∏£‡∏≠‡∏ö‡πÅ‡∏Ç‡∏ô (cm)"};function renderBodyStatsPage(){const e=document.getElementById("body-stat-select");e.innerHTML="",Object.keys(bodyStatMetrics).forEach(t=>{e.innerHTML+=`<option value="${t}">${bodyStatMetrics[t]}</option>`}),renderBodyStatsHistory(),renderBodyStatChart(e.value)}
    function saveBodyStats(){const e=new Date().toISOString().slice(0,10),t={date:e};let a=!1;Object.keys(bodyStatMetrics).forEach(e=>{const n=document.getElementById(`stat-${e}`);n.value&&(t[e]=parseFloat(n.value),a=!0,n.value="")}),a?(-1<(o=bodyStats.findIndex(t=>t.date===e))?bodyStats[o]={...bodyStats[o],...t}:bodyStats.push(t),bodyStats.sort((e,t)=>new Date(t.date)-new Date(e.date)),localStorage.setItem("gymBodyStats",JSON.stringify(bodyStats)),renderBodyStatsPage(),alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß!")):alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á");var o}
    function renderBodyStatsHistory(){const e=document.getElementById("body-stats-history-list");if(e.innerHTML="",0===bodyStats.length)return void(e.innerHTML="<li>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</li>");bodyStats.forEach(t=>{let a=`<strong>${new Date(t.date).toLocaleDateString("th-TH",{dateStyle:"long"})}</strong><br/>`;Object.keys(t).forEach(e=>{"date"!==e&&(a+=`${bodyStatMetrics[e]}: ${t[e]} | `)}),e.innerHTML+=`<li>${a.slice(0,-2)}</li>`})}
    function renderBodyStatChart(e){if(bodyStatChart&&bodyStatChart.destroy(),0!==bodyStats.length){const t={labels:[],values:[]};bodyStats.slice().reverse().forEach(a=>{a[e]&&(t.labels.push(new Date(a.date).toLocaleDateString("th-TH",{month:"short",day:"numeric"})),t.values.push(a[e]))});const a=document.getElementById("bodyStatChart").getContext("2d");bodyStatChart=new Chart(a,{type:"line",data:{labels:t.labels,datasets:[{label:bodyStatMetrics[e],data:t.values,borderColor:"rgba(3, 218, 198, 1)",tension:.1}]},options:{plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!1}}}})}}
    
    function parseThaiDate(dateString) { 
        if (!dateString) return null;
        const months = {"‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°":0,"‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå":1,"‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°":2,"‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô":3,"‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°":4,"‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô":5,"‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°":6,"‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°":7,"‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô":8,"‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°":9,"‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô":10,"‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°":11};
        const cleanedString = dateString.replace('üóìÔ∏è', '').replace('‡∏ß‡∏±‡∏ô', '').replace('‡∏ó‡∏µ‡πà', '').trim();
        const parts = cleanedString.split(/\s+/);
        let day, monthStr, yearStr;

        if (parts.length < 3) return null;

        // More robust parsing for Thai dates
        day = parts.find(p => !isNaN(parseInt(p)) && p.length <= 2);
        yearStr = parts.find(p => !isNaN(parseInt(p)) && p.length === 4);
        monthStr = parts.find(p => months.hasOwnProperty(p));

        if (!day || !monthStr || !yearStr) return null;

        const month = months[monthStr];
        const year = parseInt(yearStr) - 543;
        if (isNaN(day) || month === undefined || isNaN(year)) return null;
        return new Date(Date.UTC(year, month, parseInt(day)));
    }

    function openPlateCalculator(cardId) { const weightInput = document.getElementById(`weight-${cardId}`); const targetWeight = parseFloat(weightInput.value); const barbellWeight = userEquipment.barbellWeight; const plates = userEquipment.availablePlates; if (isNaN(targetWeight) || targetWeight <= barbellWeight) { alert(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ ${barbellWeight} kg (‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÅ‡∏Å‡∏ô‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)`); return; } const weightPerSide = (targetWeight - barbellWeight) / 2; if (weightPerSide < 0) { alert("‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÅ‡∏Å‡∏ô"); return; } let remainingWeight = weightPerSide; const platesResult = []; plates.forEach(plateWeight => { while (remainingWeight >= plateWeight) { platesResult.push(plateWeight); remainingWeight -= plateWeight; } }); document.getElementById('calculator-target-weight').innerText = `${targetWeight} kg`; document.getElementById('plates-per-side-text').innerText = `‡πÅ‡∏ú‡πà‡∏ô‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≤‡∏á: ${platesResult.length > 0 ? platesResult.join(', ') : '‡πÑ‡∏°‡πà‡∏°‡∏µ'}`; const vizContainer = document.getElementById('barbell-visualization'); vizContainer.innerHTML = ''; platesResult.slice().reverse().forEach(p => { const plateEl = document.createElement('div'); plateEl.className = 'plate'; plateEl.innerText = p; vizContainer.appendChild(plateEl); }); vizContainer.innerHTML += '<div class="barbell-sleeve"></div>'; document.getElementById('plate-calculator-modal').style.display = 'block'; }
    function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
    window.onclick = function(event) { if (event.target.classList.contains('modal')) { event.target.style.display = 'none'; } }
</script>

</body>
</html>
